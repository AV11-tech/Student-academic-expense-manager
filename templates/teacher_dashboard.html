<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  margin: 0;
  background: #f4f6f9;
  font-family: Arial, sans-serif;
}
.sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: 260px;
  height: 100vh;
  background: #111827;
  color: #fff;
}
.sidebar h4 {
  padding: 20px;
  text-align: center;
  border-bottom: 1px solid #1f2937;
}
.sidebar a {
  display: block;
  padding: 14px 20px;
  color: #cbd5e1;
  text-decoration: none;
  cursor: pointer;
}
.sidebar a:hover {
  background: #1f2937;
}
.main {
  margin-left: 260px;
  padding: 30px;
}
.card { margin-bottom: 20px; }
.hidden { display: none; }
.chat-box {
  height: 300px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 10px;
  background: #fff;
}
.chat-msg {
  margin-bottom: 8px;
  padding: 8px;
  border-radius: 5px;
}
.chat-teacher { 
  font-weight: bold; 
  color: #2563eb;
  background: #f0f4ff;
  padding: 8px;
  border-radius: 5px;
}
.chat-student { 
  font-weight: bold; 
  color: #16a34a;
  background: #f0fff4;
  padding: 8px;
  border-radius: 5px;
}
.chat-sent {
  text-align: right;
  background: #e0f2fe;
}
.refresh-status {
  font-size: 12px;
  color: #666;
  margin-top: 5px;
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h4>ğŸ‘©â€ğŸ« Teacher Panel</h4>
  <a onclick="showSection('attendance')">ğŸ“… Attendance</a>
  <a onclick="showSection('marks')">ğŸ“Š Subjects & Marks</a>
  <a onclick="showSection('courses')">ğŸ“š Courses</a>
  <a onclick="showSection('assignments')">ğŸ“ Assignments</a>
  <a onclick="showSection('grading')">âœ… Assignment Grading</a>
  <a onclick="showSection('notices')">ğŸ“¢ Notices</a>
  <a onclick="showSection('messages')">ğŸ’¬ Messages</a>
  <a onclick="showSection('fees')">ğŸ’° Fees</a>
  <a onclick="showSection('posted')">ğŸ“‚ Posted Data</a>
  <a href="/logout">ğŸšª Logout</a>
</div>

<div class="main">
<h3>
  Welcome, {{ current_user.username }}
  <span class="badge bg-dark">Teacher</span>
</h3>
<hr>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- ATTENDANCE -->
<div id="attendance">
<div class="card">
  <div class="card-header"><strong>Mark Attendance</strong></div>
  <div class="card-body">
    <form method="POST" action="/add-attendance" class="row g-2">
      <div class="col-md-4">
        <select name="user_id" class="form-control" required>
          {% for s in students %}
            <option value="{{ s.id }}">{{ s.username }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <input type="date" name="date" class="form-control" required>
      </div>
      <div class="col-md-3">
        <select name="status" class="form-control">
          <option>Present</option>
          <option>Absent</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-success w-100">Save</button>
      </div>
    </form>
  </div>
</div>
</div>

<!-- MARKS -->
<div id="marks" class="hidden">
<div class="card">
  <div class="card-header"><strong>Add Marks</strong></div>
  <div class="card-body">
    <form method="POST" action="/add-score" class="row g-2">
      <div class="col-md-4">
        <select name="user_id" class="form-control" required>
          {% for s in students %}
            <option value="{{ s.id }}">{{ s.username }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <input name="subject" class="form-control" placeholder="Subject" required>
      </div>
      <div class="col-md-2">
        <input name="marks" type="number" class="form-control" placeholder="Marks" required>
      </div>
      <div class="col-md-2">
        <button class="btn btn-success w-100">Add</button>
      </div>
    </form>
  </div>
</div>
</div>

<!-- COURSES -->
<div id="courses" class="hidden">
<div class="card">
  <div class="card-header"><strong>Add Course</strong></div>
  <div class="card-body">
    <form method="POST" action="/add-course" class="row g-2">
      <div class="col-md-6">
        <input name="name" class="form-control" placeholder="Course Name" required>
      </div>
      <div class="col-md-4">
        <input name="code" class="form-control" placeholder="Course Code (Optional)">
      </div>
      <div class="col-md-2">
        <button class="btn btn-success w-100">Add</button>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header"><strong>Posted Courses</strong></div>
  <div class="card-body">
    {% if courses %}
      <table class="table table-bordered">
        <tr><th>Course Name</th><th>Course Code</th><th>Posted By</th></tr>
        {% for c in courses %}
        <tr>
          <td>{{ c.name }}</td>
          <td>{{ c.code if c.code else 'â€”' }}</td>
          <td>Teacher (ID: {{ c.teacher_id }})</td>
        </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No courses added yet.</p>
    {% endif %}
  </div>
</div>
</div>

<!-- ASSIGNMENTS -->
<div id="assignments" class="hidden">
<div class="card">
  <div class="card-header"><strong>Post Assignment</strong></div>
  <div class="card-body">
    <form method="POST" action="/add-assignment" enctype="multipart/form-data">
      <input name="title" class="form-control mb-2" placeholder="Title" required>
      <input name="subject" class="form-control mb-2" placeholder="Subject" required>
      <input type="date" name="deadline" class="form-control mb-2" required>
      <input type="file" name="file" class="form-control mb-2">
      <button class="btn btn-primary">Post Assignment</button>
    </form>
  </div>
</div>
</div>

<!-- ASSIGNMENT GRADING -->
<div id="grading" class="hidden">
<div class="card">
  <div class="card-header"><strong>Assignment Submissions</strong></div>
  <div class="card-body">
    {% for submission, student_name, assignment_title in submissions %}
      <div class="border p-3 mb-2">
        <strong>{{ student_name }}</strong> â€” {{ assignment_title }}<br>
        <a href="{{ url_for('static', filename='uploads/' ~ submission.file) }}" target="_blank">View Submission</a>

        <form method="POST" action="/grade-assignment" class="row g-2 mt-2">
          <input type="hidden" name="submission_id" value="{{ submission.id }}">
          <div class="col-md-3">
            <input type="number" name="marks" class="form-control" placeholder="Marks" required>
          </div>
          <div class="col-md-7">
            <input name="remarks" class="form-control" placeholder="Remarks">
          </div>
          <div class="col-md-2">
            <button class="btn btn-success w-100">Grade</button>
          </div>
        </form>
      </div>
    {% else %}
      <p>No submissions yet.</p>
    {% endfor %}
  </div>
</div>
</div>

<!-- NOTICES -->
<div id="notices" class="hidden">
<div class="card">
  <div class="card-header"><strong>Post Notice</strong></div>
  <div class="card-body">
    <form method="POST" action="/add-notice" enctype="multipart/form-data">
      <textarea name="message" class="form-control mb-2" placeholder="Write your notice here..." rows="4" required></textarea>
      <input type="file" name="file" class="form-control mb-2">
      <button class="btn btn-primary">Post Notice</button>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header"><strong>Posted Notices</strong></div>
  <div class="card-body">
    {% for notice, teacher_name in notices %}
      <div class="border p-3 mb-3">
        <strong>{{ teacher_name }}</strong><br>
        <p>{{ notice.message }}</p>
        {% if notice.file %}
          <a href="{{ url_for('static', filename='uploads/' ~ notice.file) }}" target="_blank">ğŸ“ Attachment</a>
        {% endif %}
      </div>
    {% else %}
      <p>No notices posted yet.</p>
    {% endfor %}
  </div>
</div>
</div>

<!-- MESSAGES -->
<div id="messages" class="hidden">
<div class="card">
  <div class="card-header"><strong>Student Messages</strong></div>
  <div class="card-body">

    <div id="chat-box" class="chat-box mb-2">
      {% for m, sender_name, sender_role in messages %}
        <div class="chat-msg {% if m.sender_id == current_user_id %}chat-sent{% endif %}">
          <span class="{{ 'chat-student' if sender_role == 'student' else 'chat-teacher' }}">
            {{ sender_name }}:
          </span>
          {{ m.text }}
        </div>
      {% else %}
        <p class="text-muted">No messages yet.</p>
      {% endfor %}
    </div>
    <div class="refresh-status">Auto-refreshing every 5 seconds...</div>

    <form id="message-form" onsubmit="sendMessage(event)">
      <select name="receiver_id" id="receiver_id" class="form-control mb-2" required>
        <option value="" selected disabled>Select Student</option>
        {% for s in students %}
          <option value="{{ s.id }}">{{ s.username }}</option>
        {% endfor %}
      </select>
      <textarea name="message" class="form-control mb-2" placeholder="Reply..." required></textarea>
      <button type="submit" class="btn btn-primary">Send</button>
    </form>

  </div>
</div>
</div>

<!-- FEES -->
<div id="fees" class="hidden">
<div class="card">
  <div class="card-header"><strong>Post Fees</strong></div>
  <div class="card-body">
    <form method="POST" action="/fee" class="row g-2">
      <div class="col-md-3"><input name="title" class="form-control" placeholder="Title" required></div>
      <div class="col-md-2"><input name="amount" type="number" class="form-control" placeholder="Amount" required></div>
      <div class="col-md-3"><input type="date" name="due_date" class="form-control" required></div>
      <div class="col-md-3">
        <select name="student_id" class="form-control" required>
          {% for s in students %}
            <option value="{{ s.id }}">{{ s.username }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-1"><button class="btn btn-success w-100">Add</button></div>
    </form>
  </div>
</div>
</div>

<!-- POSTED DATA -->
<div id="posted" class="hidden">
  <div class="card">
    <div class="card-header"><strong>Posted Data</strong></div>
    <div class="card-body">

      <h6>ğŸ“… Attendance</h6>
      <ul>
        {% for a in attendance %}
          <li>
            Student ID {{ a.user_id }} â€”
            {{ a.date }} â€”
            {{ a.status }}
          </li>
        {% else %}
          <li>No attendance records</li>
        {% endfor %}
      </ul>

      <hr>

      <h6>ğŸ“Š Subjects & Marks</h6>
      <ul>
        {% for s in scores %}
          <li>
            Student ID {{ s.user_id }} â€”
            {{ s.subject }} â€”
            {{ s.marks }}
          </li>
        {% else %}
          <li>No marks added</li>
        {% endfor %}
      </ul>

      <hr>

      <h6>ğŸ’° Fees</h6>
      <ul>
        {% for f in fees %}
          <li>
            {{ f.title }} â€”
            â‚¹{{ f.amount }} â€”
            {{ f.status }}
          </li>
        {% else %}
          <li>No fees posted</li>
        {% endfor %}
      </ul>

    </div>
  </div>
</div>

</div>

<script>
const current_user_id = {{ current_user_id }};

function showSection(id) {
  // hide all sections
  document.querySelectorAll('.main > div[id]').forEach(div => {
    div.classList.add('hidden');
  });

  // show selected section
  document.getElementById(id).classList.remove('hidden');

  // store section in URL
  window.location.hash = id;
}

// Send message via AJAX
function sendMessage(event) {
  event.preventDefault();
  try {
    console.log('sendMessage called');
    const form = document.getElementById('message-form');
    if (!form) {
      console.error('Message form not found');
      return;
    }

    const receiverEl = document.getElementById('receiver_id');
    if (!receiverEl) {
      console.error('Receiver select not found');
      return;
    }

    const receiverId = receiverEl.value;

    // Validate receiver_id
    if (!receiverId || receiverId === '') {
      alert('Please select a student to send the message to.');
      return;
    }

    // Validate current_user_id doesn't match receiver_id
    if (parseInt(receiverId) === current_user_id) {
      alert('You cannot send a message to yourself.');
      return;
    }

    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) submitBtn.disabled = true;

    const formData = new FormData(form);

    fetch('/send-message', {
      method: 'POST',
      headers: { 'Accept': 'application/json' },
      body: formData
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.status);
      }
      return response.json();
    })
    .then(data => {
      console.log('send-message response:', data);
      if (data && data.success) {
        form.reset();
        refreshMessages(); // Refresh messages immediately after sending
      } else {
        alert((data && data.message) ? data.message : 'Failed to send message');
      }
    })
    .catch(err => {
      console.error('Error sending message:', err);
      alert('Error sending message. See console for details.');
    })
    .finally(() => {
      if (submitBtn) submitBtn.disabled = false;
    });
  } catch (e) {
    console.error('sendMessage exception:', e);
  }
}

// Auto-refresh messages every 5 seconds
function refreshMessages() {
  fetch('/api/messages')
    .then(response => response.json())
    .then(messages => {
      const chatBox = document.getElementById('chat-box');
      if (!chatBox) return;
      
      // Build HTML for messages
      let html = '';
      if (messages.length === 0) {
        html = '<p class="text-muted">No messages yet.</p>';
      } else {
        messages.forEach(msg => {
          const senderClass = msg.sender_role === 'student' ? 'chat-student' : 'chat-teacher';
          const sentClass = msg.is_sent ? 'chat-sent' : '';
          html += `<div class="chat-msg ${sentClass}">
            <span class="${senderClass}">${msg.sender_name}:</span>
            ${msg.text}
          </div>`;
        });
      }
      
      chatBox.innerHTML = html;
      // Auto-scroll to bottom
      chatBox.scrollTop = chatBox.scrollHeight;
    })
    .catch(err => console.log('Error refreshing messages:', err));
}

// when page reloads, open correct section
window.onload = function () {
  const section = window.location.hash.replace('#', '') || 'attendance';
  showSection(section);
  
  // Set interval for auto-refresh
  setInterval(function() {
    if (!document.getElementById('messages').classList.contains('hidden')) {
      refreshMessages();
    }
  }, 5000);
};

// Store original showSection for wrapping
const originalShowSection = showSection;
// Override to refresh messages when switching to messages section
window.showSection = function(id) {
  originalShowSection(id);
  if (id === 'messages') {
    refreshMessages(); // Refresh immediately when switching to messages
  }
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
