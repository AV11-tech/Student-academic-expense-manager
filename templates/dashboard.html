<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  margin: 0;
  background: #f4f6f9;
  font-family: Arial, sans-serif;
}

.sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: 260px;
  height: 100vh;
  background: #111827;
  color: #fff;
}

.sidebar h4 {
  padding: 20px;
  text-align: center;
  border-bottom: 1px solid #1f2937;
}

.sidebar a {
  display: block;
  padding: 14px 20px;
  color: #cbd5e1;
  text-decoration: none;
  cursor: pointer;
}

.sidebar a:hover {
  background: #1f2937;
}

.main {
  margin-left: 260px;
  padding: 30px;-
}

.card {
  margin-bottom: 20px;
}

.profile-img {
  width: 140px;
  height: 140px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #e5e7eb;
}

.hidden {
  display: none;
}

.chat-box {
  height: 300px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 10px;
  background: #fff;
}

.chat-msg {
  margin-bottom: 8px;
  padding: 8px;
  border-radius: 5px;
}

.chat-teacher {
  font-weight: bold;
  color: #2563eb;
  background: #f0f4ff;
  padding: 8px;
  border-radius: 5px;
}

.chat-student {
  font-weight: bold;
  color: #16a34a;
  background: #f0fff4;
  padding: 8px;
  border-radius: 5px;
}

.chat-sent {
  text-align: right;
  background: #e0f2fe;
}

.refresh-status {
  font-size: 12px;
  color: #666;
  margin-top: 5px;
}
</style>
</head>

<body>

<!-- ================= SIDEBAR ================= -->
<div class="sidebar">
  <h4>ğŸ“ Student Panel</h4>

  <a onclick="showSection('profile')">ğŸ‘¤ Personal Profile</a>
  <a onclick="showSection('courses')">ğŸ“š Courses</a>
  <a onclick="showSection('attendance')">ğŸ“… Attendance</a>
  <a onclick="showSection('marks')">ğŸ“Š Subjects & Marks</a>
  <a onclick="showSection('notices')">ğŸ“¢ Notices</a>
  <a onclick="showSection('assignments')">ğŸ“¤ Assignments</a>
  <a onclick="showSection('notes')">ğŸ“ Notes</a>
  <a onclick="showSection('fees')">ğŸ’³ Fees & Payments</a>
  <a onclick="showSection('messages')">ğŸ’¬ Messages</a>

  <a href="/logout">ğŸšª Logout</a>
</div>

<!-- ================= MAIN ================= -->
<div class="main">

<h3>
  Welcome, {{ current_user.username }}
  <span class="badge bg-secondary">{{ current_user.role|capitalize }}</span>
</h3>

<hr>

<!-- ================= PROFILE ================= -->
<div id="profile">

<div class="card">
  <div class="card-header"><strong>Personal Profile</strong></div>
  <div class="card-body">

    <div class="row align-items-center">

      <div class="col-md-3 text-center">
        {% if profile and profile.profile_image %}
          <img src="{{ url_for('static', filename='uploads/' ~ profile.profile_image) }}" class="profile-img">
        {% else %}
          <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="profile-img">
        {% endif %}
      </div>

      <div class="col-md-9">

        <form method="POST" action="/update-profile" enctype="multipart/form-data">
          <div class="row">
            <div class="col-md-6 mb-2">
              <input class="form-control" name="full_name" placeholder="Full Name"
                     value="{{ profile.full_name if profile else '' }}" required>
            </div>

            <div class="col-md-6 mb-2">
              <input class="form-control" name="school" placeholder="School / College"
                     value="{{ profile.school if profile else '' }}" required>
            </div>

            <div class="col-md-6 mb-2">
              <input class="form-control" name="course" placeholder="Course Name"
                     value="{{ profile.course if profile else '' }}" required>
            </div>

            <div class="col-md-6 mb-2">
              <input class="form-control" name="semester" placeholder="Semester"
                     value="{{ profile.semester if profile else '' }}" required>
            </div>

            <div class="col-md-6 mb-2">
              <input class="form-control" name="student_id" placeholder="Student ID / TC"
                     value="{{ profile.student_id if profile else '' }}">
            </div>

            <div class="col-md-6 mb-2">
              <input type="file" name="profile_image" class="form-control">
            </div>
          </div>

          <button class="btn btn-primary mt-2">Save Profile</button>
        </form>

      </div>

    </div>

  </div>
</div>

</div>

<!-- ================= COURSES ================= -->
<div id="courses" class="hidden">
  <div class="card">
    <div class="card-header"><strong>Available Courses</strong></div>
    <div class="card-body">
      {% if courses %}
        <table class="table table-bordered">
          <tr><th>Course Name</th><th>Course Code</th><th>Teacher</th></tr>
          {% for c in courses %}
          <tr>
            <td>{{ c.name }}</td>
            <td>{{ c.code if c.code else 'â€”' }}</td>
            <td>Teacher ID: {{ c.teacher_id }}</td>
          </tr>
          {% endfor %}
        </table>
      {% else %}
        <p>No courses available yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- ================= ATTENDANCE ================= -->
<div id="attendance" class="hidden">
  <div class="card">
    <div class="card-header"><strong>Attendance</strong></div>
    <div class="card-body">
      <table class="table table-bordered">
        <tr><th>Date</th><th>Status</th></tr>
        {% for a in attendance %}
        <tr>
          <td>{{ a.date }}</td>
          <td>{{ a.status }}</td>
        </tr>
        {% else %}
        <tr><td colspan="2">No records</td></tr>
        {% endfor %}
      </table>
    </div>
  </div>
</div>

<!-- ================= MARKS ================= -->
<div id="marks" class="hidden">
  <div class="card">
    <div class="card-header"><strong>Subjects & Marks</strong></div>
    <div class="card-body">
      <table class="table table-bordered">
        <tr><th>Subject</th><th>Marks</th></tr>
        {% for m in scores %}
        <tr>
          <td>{{ m.subject }}</td>
          <td>{{ m.marks }}</td>
        </tr>
        {% else %}
        <tr><td colspan="2">No marks</td></tr>
        {% endfor %}
      </table>
    </div>
  </div>
</div>

<!-- ================= NOTICES ================= -->
<div id="notices" class="hidden">
  <div class="card">
    <div class="card-header"><strong>Notices</strong></div>
    <div class="card-body">
      {% for n in notices %}
        <p>
          <strong>{{ n.message }}</strong><br>
          {% if n.file %}
            <a href="{{ url_for('static', filename='uploads/' ~ n.file) }}" target="_blank">ğŸ“ Attachment</a>
          {% endif %}
        </p>
        <hr>
      {% else %}
        <p>No notices</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ================= ASSIGNMENTS ================= -->
<div id="assignments" class="hidden">
  <div class="card">
    <div class="card-header"><strong>Submit Assignment</strong></div>
    <div class="card-body">
      <form method="POST" action="/submit-assignment" enctype="multipart/form-data">
        <select name="assignment_id" class="form-control mb-2" required>
          <option value="">Select Assignment</option>
          {% for a in assignments %}
            <option value="{{ a.id }}">{{ a.title }} ({{ a.subject }})</option>
          {% endfor %}
        </select>
        <input type="file" class="form-control mb-2" name="file" required>
        <button class="btn btn-success">Submit</button>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><strong>My Submissions</strong></div>
    <div class="card-body">
      {% for submission, assignment_title, assignment_subject in submissions %}
        <p>
          <strong>{{ assignment_title }}</strong> ({{ assignment_subject }})<br>
          Submitted on: {{ submission.submitted_on }} |
          {% if submission.file %}
            <a href="{{ url_for('static', filename='uploads/' ~ submission.file) }}" target="_blank">View Submission</a>
          {% endif %}
          {% if submission.marks %}
            | Marks: {{ submission.marks }}
          {% endif %}
          {% if submission.remarks %}
            | Remarks: {{ submission.remarks }}
          {% endif %}
        </p>
        <hr>
      {% else %}
        <p>No submissions yet.</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ================= NOTES ================= -->
<div id="notes" class="hidden">
  <div class="card">
    <div class="card-header"><strong>My Notes</strong></div>
    <div class="card-body">
      <textarea class="form-control" rows="6" placeholder="Write your notes here..."></textarea>
      <input type="file" class="form-control mt-2">
      <button class="btn btn-primary mt-2">Save Note</button>
    </div>
  </div>
</div>

<!-- ================= FEES ================= -->
<div id="fees" class="hidden">
  <div class="card">
    <div class="card-header"><strong>Fees & Payments</strong></div>
    <div class="card-body">
      <ul>
        {% for f in fees %}
          <li>
            <strong>{{ f.title }}</strong> â€” 
            â‚¹{{ f.amount }} â€” 
            Due: {{ f.due_date }} â€” 
            Status: <span class="badge {% if f.status == 'Pending' %}bg-warning{% elif f.status == 'Paid' %}bg-success{% else %}bg-secondary{% endif %}">{{ f.status }}</span>
          </li>
        {% else %}
          <li>No fees assigned.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<!-- ================= MESSAGES ================= -->
<div id="messages" class="hidden">
  <div class="card">
    <div class="card-header"><strong>Messages</strong></div>
    <div class="card-body">
      <div id="chat-box" class="chat-box mb-2">
        {% for m, sender_name, sender_role in messages %}
          <div class="chat-msg {% if m.sender_id == current_user_id %}chat-sent{% endif %}">
            <span class="{{ 'chat-student' if sender_role == 'student' else 'chat-teacher' }}">{{ sender_name }}:</span>
            {{ m.text }}
          </div>
        {% else %}
          <p class="text-muted">No messages yet.</p>
        {% endfor %}
      </div>
      <div class="refresh-status">Auto-refreshing every 5 seconds...</div>

      <form id="message-form" onsubmit="sendMessage(event)">
        <select name="receiver_id" id="receiver_id" class="form-control mb-2" required>
          <option value="" selected disabled>Select Teacher</option>
          {% for t in teachers %}
            <option value="{{ t.id }}">{{ t.username }}</option>
          {% endfor %}
        </select>
        <textarea name="message" class="form-control" rows="4" placeholder="Type your message..." required></textarea>
        <button type="submit" class="btn btn-success mt-2">Send</button>
      </form>
    </div>
  </div>
</div>

</div>

<!-- ================= SCRIPT ================= -->
<script>
const current_user_id = {{ current_user_id }};

function showSection(id) {
  document.querySelectorAll('.main > div[id]').forEach(div => {
    div.classList.add('hidden');
  });
  document.getElementById(id).classList.remove('hidden');
}

// Send message via AJAX
function sendMessage(event) {
  event.preventDefault();
  const form = document.getElementById('message-form');
  const receiverId = document.getElementById('receiver_id').value;
  
  // Validate receiver_id
  if (!receiverId || receiverId === '') {
    alert('Please select a teacher to send the message to.');
    return;
  }
  
  // Validate current_user_id doesn't match receiver_id
  if (parseInt(receiverId) === current_user_id) {
    alert('You cannot send a message to yourself.');
    return;
  }
  
  const formData = new FormData(form);
  
  fetch('/send-message', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      form.reset();
      refreshMessages(); // Refresh messages immediately after sending
    }
  })
  .catch(err => console.log('Error sending message:', err));
}

// Auto-refresh messages every 5 seconds
function refreshMessages() {
  fetch('/api/messages')
    .then(response => response.json())
    .then(messages => {
      const chatBox = document.getElementById('chat-box');
      if (!chatBox) return;
      
      // Build HTML for messages
      let html = '';
      if (messages.length === 0) {
        html = '<p class="text-muted">No messages yet.</p>';
      } else {
        messages.forEach(msg => {
          const senderClass = msg.sender_role === 'student' ? 'chat-student' : 'chat-teacher';
          const sentClass = msg.is_sent ? 'chat-sent' : '';
          html += `<div class="chat-msg ${sentClass}">
            <span class="${senderClass}">${msg.sender_name}:</span>
            ${msg.text}
          </div>`;
        });
      }
      
      chatBox.innerHTML = html;
      // Auto-scroll to bottom
      chatBox.scrollTop = chatBox.scrollHeight;
    })
    .catch(err => console.log('Error refreshing messages:', err));
}

// Refresh messages when on messages section
window.onload = function () {
  const section = window.location.hash.replace('#', '') || 'profile';
  showSection(section);
  
  // Set interval for auto-refresh
  setInterval(function() {
    if (!document.getElementById('messages').classList.contains('hidden')) {
      refreshMessages();
    }
  }, 5000);
};

// Refresh when switching to messages section
const originalShowSection = showSection;
showSection = function(id) {
  originalShowSection(id);
  if (id === 'messages') {
    refreshMessages(); // Refresh immediately when switching to messages
  }
};
</script>

</body>
</html>
